"use strict";var userReg=document.getElementById("user-reg"),userRegTip=document.getElementById("user-reg-tip"),chatMsgSend=document.getElementsByClassName("chat-msg-send")[0],infoTab=document.getElementsByClassName("info-tab")[0],chatMsgList=document.getElementsByClassName("chat-msg-list")[0],userList=document.getElementsByClassName("user-lists")[0],roomList=document.getElementsByClassName("room-list")[0],chatMoreBox=document.getElementsByClassName("chat-more-box")[0],inputRadioSex=document.getElementsByClassName("input-radio-sex"),userImgChoose=document.getElementsByClassName("user-img-choose")[0],socketHostName=document.location.hostname,socketURI="http://"+socketHostName+":8089/",socket=io(socketURI),nodejsChat={};nodejsChat.data={isRoomInit:!1,messIsFirst:!0,messIsFoucs:!1,isInitInsertEmoji:!1,onlineUserCount:0,onlineUserList:[],onlineUserListImg:[],defaultUserImg:"https://randomuser.me/api/portraits/women/50.jpg",welcomeInfo:"系统: 欢迎来到 ",roomID:null,user:{name:null,pass:null,desc:null,img:"https://randomuser.me/api/portraits/men/1.jpg",sex:"men"},robot:{api:"api/robot/openapi/api",key:"57a5b6849e2b4d47ae0badadf849c261",nick:"小美",img:"https://randomuser.me/api/portraits/women/60.jpg"}},nodejsChat.room={init:function(){socket.on("request room id",function(){roomList.innerHTML="",socket.emit("response room id",nodejsChat.data.roomID),nodejsChat.method.insertToList(chatMsgList,"li",nodejsChat.data.welcomeInfo+nodejsChat.data.roomID),chatMsgSend.value="",chatMoreBox.style.visibility="hidden",chatMsgSend.onclick=function(){chatMoreBox.style.visibility="hidden",nodejsChat.data.messIsFoucs=!0}}),socket.on("add room",function(e){var t=document.location.origin,s='<a href="'+t+"/room/"+e+'" class="room-link">'+e+"</a>";nodejsChat.method.insertToList(roomList,"li",s)}),socket.on("user login req",function(e){nodejsChat.method.insertToList(chatMsgList,"li",e)}),socket.on("user logout req",function(e){console.log(e),nodejsChat.method.insertToList(chatMsgList,"li",e.currentUser+" 离开了房间"),nodejsChat.method.toBottom(),nodejsChat.method.initList(userList);for(var t=e.currentUserList.length,s=0;s<t;s++){var o=nodejsChat.method.renderUserList(e.currentUserListImg,e.currentUserList[s]);nodejsChat.method.insertToList(userList,"li",o)}}),socket.on("show latest talk",function(e){console.log(e);for(var t=e.length,s=0;s<t;s++){var o=nodejsChat.method.renderBubbleMsg("left",e[s].user,nodejsChat.method.parseTime(e[s].time),nodejsChat.method.parseMsgVal(e[s].mess),e[s].img);nodejsChat.method.insertToList(chatMsgList,"li",o)}nodejsChat.method.toBottom()})},render:function(){socket.on("current status",function(e){nodejsChat.method.initList(userList),nodejsChat.method.getOnlineList(e.room,nodejsChat.data.roomID);var t=nodejsChat.data.onlineUserList.length;if(0!==t)for(var s=0;s<t;s++){var o=nodejsChat.method.renderUserList(nodejsChat.data.onlineUserListImg[s],nodejsChat.data.onlineUserList[s]);nodejsChat.method.insertToList(userList,"li",o)}var n=e.roomList.length;if(0!==n)for(var s=0;s<n;s++){var a=document.location.origin,i=e.roomList[s];if(0===s)var r='<a href="'+a+'" class="room-link" target="_black">'+i+"</a>";else var r='<a href="'+a+"/room/"+i+'" class="room-link" target="_black">'+i+"</a>";nodejsChat.method.insertToList(roomList,"li",r)}console.log(e),console.log("在线统计："+nodejsChat.data.onlineUserCount),console.log("在线用户："+nodejsChat.data.onlineUserList)}),socket.on("user add to list req",function(e){void 0===e.name||null===e.name?nodejsChat.data.defaultUserImg:e.name;var t=nodejsChat.method.renderUserList(e.img,e.name);nodejsChat.method.insertToList(userList,"li",t)}),socket.on("send message res",function(e){var t=nodejsChat.method.parseTime(e.time),s=nodejsChat.method.renderBubbleMsg("left",e.user,t,nodejsChat.method.parseMsgVal(e.msg),e.img);nodejsChat.method.insertToList(chatMsgList,"li",s);var o=e.length;console.log("total message / "+o),nodejsChat.method.toBottom()}),socket.on("user add res",function(e){if(e.status){userRegTip.innerHTML="注册成功",chatMsgSend.focus();var t=nodejsChat.method.renderUserList(nodejsChat.data.user.img,e.user);nodejsChat.method.insertToList(userList,"li",t)}else userRegTip.innerHTML="用户名已存在",nodejsChat.data.user.name=null;console.log(e),console.log("当前在线："+e.user.length),console.log("注册状态："+e.status)})}},nodejsChat.method={getRoomID:function(){var e=document.location.pathname,t="/"===e,s=null;return t||-1===e.indexOf("room")||(s=e.replace(/\/.*?\//,"")),null===s?s="Chat Room":decodeURIComponent(s)},initList:function(e){e.innerHTML=""},renderList:function(e,t,s){for(var o={room:roomList,user:userList,chat:chatMsgList,emoji:chatMoreBox},n=0;n<t.length;n++)this.insertToList(o[e],"li",t[n])},insertToList:function(e,t,s){var o=document.createElement(t);o.innerHTML=s,e.appendChild(o)},renderUserList:function(e,t){return'<img src="'+e+'" class="user-img">\n      <span class="user-name">'+t+"</span>"},renderBubbleMsg:function(e,t,s,o,n){var a;return a=""!==s?'<li class="bubble-info-time">'+s+"</li>":"",void 0!==n&&null!==n||(n=nodejsChat.data.defaultUserImg),'<div class="bubble bubble-'+e+'">\n      <div class="bubble-head">\n        <img src='+n+' class="user-img">\n      </div>\n      <div class="bubble-ctx">\n        <ul class="bubble-info">\n          <li class="bubble-info-user">'+t+"</li>\n          "+a+'\n        </ul>\n        <div class="bubble-ctx-border">\n          <p class="bubble-ctx-show">'+o+"</p>\n        </div>\n      </div>\n    </div>"},parseMsgVal:function(e){var t=e.replace(/</g,"&lt;");return t=t.replace(/>/g,"&gt;")},getTime:function(e){return Date.parse(e)/1e3},parseTime:function(e){var t=new Date;return t.setTime(1e3*e),t.toLocaleString()},sendMessage:function(){if(""!==chatMsgSend.value){chatMoreBox.style.visibility="hidden";var e=nodejsChat.method.getTime(new Date),t=null!==nodejsChat.data.user.name?nodejsChat.data.user.name:"神秘人",s=nodejsChat.method.parseMsgVal(chatMsgSend.value),o=nodejsChat.method.renderBubbleMsg("right",t,"",s,nodejsChat.data.user.img);socket.emit("send message req",e,nodejsChat.data.roomID,{user:t,time:e,msg:s,img:nodejsChat.data.user.img}),nodejsChat.method.insertToList(chatMsgList,"li",o),chatMsgSend.value="",chatMsgSend.focus(),nodejsChat.method.toBottom(),axios.get(nodejsChat.data.robot.api,{params:{key:nodejsChat.data.robot.key,info:s}}).then(function(e){var t=nodejsChat.method.getTime(new Date),s=nodejsChat.method.parseTime(t),o=nodejsChat.method.renderBubbleMsg("left",nodejsChat.data.robot.nick,s,e.data.text,nodejsChat.data.robot.img);nodejsChat.method.insertToList(chatMsgList,"li",o),socket.emit("send message req",t,nodejsChat.data.roomID,{user:nodejsChat.data.robot.nick,time:t,msg:e.data.text,img:nodejsChat.data.robot.img}),nodejsChat.method.toBottom()}).catch(function(e){console.log(e)})}else userRegTip.innerHTML="内容不能为空"},regUser:function(){nodejsChat.data.user.name?userRegTip.innerHTML="已登陆，用户名为："+nodejsChat.data.user.name:""!==userReg.value&&" "!==userReg.value?(userRegTip.innerHTML="注册中...",nodejsChat.data.user.name=nodejsChat.method.parseMsgVal(userReg.value),socket.emit("user add req",nodejsChat.data.roomID,{name:nodejsChat.method.parseMsgVal(userReg.value),img:nodejsChat.data.user.img})):userRegTip.innerHTML="请输入用户名"},getOnlineList:function(e,t){e.filter(function(e){if(e.name===t){var s=e.user.concat(),o=e.img.concat();nodejsChat.data.onlineUserCount=e.user.length,nodejsChat.data.onlineUserList=s,nodejsChat.data.onlineUserListImg=o}})},getRandomImg:function(e){return"https://randomuser.me/api/portraits/"+e+"/"+parseInt(100*Math.random())+".jpg"},getRandomNick:function(e,t){return"https://uinames.com/api/?region="+e+"&gender="+t+"&amount=1"},getEmoji:function(e){var t=["😅","😂","🙂","🙃","😉","😘","😗","😜","😎","😏","😔","🙁","😶","😢","🤔","👏","🤝","👍","👎","✌","❤","🐶","🐱","🐰","🐭","🐷","🐸","🙈"],s=e||chatMoreBox;this.initList(s),"hidden"===s.style.visibility?chatMoreBox.style.visibility="visible":chatMoreBox.style.visibility="hidden",this.renderList("emoji",t),!1===nodejsChat.data.isInitInsertEmoji&&this.initInsertEmoji()},initInsertEmoji:function(){chatMoreBox.addEventListener("click",function(e){"li"===e.target.tagName.toLowerCase()&&nodejsChat.method.insertEmoji(e.target.innerText)},!1),nodejsChat.data.isInitInsertEmoji=!0},insertEmoji:function(e){var t=chatMsgSend.value,s=chatMsgSend.selectionStart;nodejsChat.data.messIsFirst&&!nodejsChat.data.messIsFoucs&&(s=t.length),nodejsChat.data.messIsFirst=!1,""===t?chatMsgSend.value=e:t.length===s?chatMsgSend.value=chatMsgSend.value+e:chatMsgSend.value=t.slice(0,s)+e+t.slice(s,t.length),chatMsgSend.focus(),console.log("currentFoucsIndex: "+s),console.log(t.length)},toBottom:function(){var e=document.getElementsByClassName("chat-ctx")[0];e.scrollTop=e.scrollHeight},checkInputRadioSex:function(){for(var e=inputRadioSex.length,t=0;t<e;t++)if(inputRadioSex[t].checked)return inputRadioSex[t].value}},document.body.onload=function(){userReg.focus(),nodejsChat.data.roomID=nodejsChat.method.getRoomID(),nodejsChat.room.init(),nodejsChat.room.render(),console.log(nodejsChat.method.getRandomImg("men")),console.log(nodejsChat.method.getRandomNick("china","male")),inputRadioSex[0].addEventListener("click",function(){var e=nodejsChat.method.checkInputRadioSex();nodejsChat.data.user.sex=e;var t=nodejsChat.method.getRandomImg(e);nodejsChat.data.user.img=t,userImgChoose.src=t},!1),inputRadioSex[1].addEventListener("click",function(){var e=nodejsChat.method.checkInputRadioSex();nodejsChat.data.user.sex=e;var t=nodejsChat.method.getRandomImg(e);nodejsChat.data.user.img=t,userImgChoose.src=t},!1),userImgChoose.addEventListener("click",function(){var e=nodejsChat.data.user.sex,t=nodejsChat.method.getRandomImg(e);nodejsChat.data.user.img=t,userImgChoose.src=t},!1),console.log(nodejsChat.method.checkInputRadioSex())};